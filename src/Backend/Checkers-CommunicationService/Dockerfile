FROM node:lts-alpine

ARG ARG_PORT
ARG ARG_GAMESERVICE_PORT
ARG ARG_USERSERVICE_PORT
ARG ARG_DB_PSW
ARG ARG_COMM_KEY
ARG ARG_COMM_CERT
ARG ARG_GAME_KEY
ARG ARG_GAME_CERT
ARG ARG_USER_KEY
ARG ARG_USER_CERT
ARG ARG_CERTIFICATE
ARG ARG_USER_SERVICE
ARG ARG_GAME_SERVICE

ENV CommunicationService_PORT=$ARG_PORT
ENV GameService_PORT=$ARG_GAMESERVICE_PORT
ENV UserService_PORT=$ARG_USERSERVICE_PORT
ENV DB_PSW=$ARG_DB_PSW
ENV COMM_KEY=$ARG_COMM_KEY
ENV COMM_CERT=$ARG_COMM_CERT
ENV GAME_KEY=$ARG_GAME_KEY
ENV GAME_CERT=$ARG_GAME_CERT
ENV USER_KEY=$ARG_USER_KEY
ENV USER_CERT=$ARG_USER_CERT
ENV CERTIFICATE=$ARG_CERTIFICATE
ENV USER_SERVICE=$ARG_USER_SERVICE
ENV GAME_SERVICE=$ARG_GAME_SERVICE

RUN mkdir -p /app/
WORKDIR /app
COPY . .
RUN npm install --unsafe-perm
RUN npm run gulp build

WORKDIR /app/build
EXPOSE $ARG_PORT
CMD npm run deploy